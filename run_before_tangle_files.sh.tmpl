#!/usr/bin/env bash

set -euo pipefail

LUGH_BIN="${HOME}/.bin/lugh"
LUGH_VERSION="v0.0.3"
LUGH_ARCHIVE="lugh-{{ .chezmoi.os }}-${LUGH_VERSION}.tar.gz"
LUGH_URL="https://github.com/marcus-crane/lugh/releases/download/${LUGH_VERSION}/${LUGH_ARCHIVE}"

if [ ! -x "$LUGH_BIN" ]; then
  echo "lugh is not at $LUGH_BIN so fetching a new copy"
  mkdir -p "${HOME}/.bin"
  TEMP_DIR=$(mktemp -d)
  trap "rm -rf $TEMP_DIR" EXIT
  curl -sL "$LUGH_URL" -o "${TEMP_DIR}/${LUGH_ARCHIVE}"
  tar -xzf "${TEMP_DIR}/${LUGH_ARCHIVE}" -C "${TEMP_DIR}"
  mv "${TEMP_DIR}/bin/lugh" "$LUGH_BIN"
  chmod +x "$LUGH_BIN"
  echo "lugh installed to $LUGH_BIN"
fi

SOURCE_PATH="{{ .chezmoi.sourceDir }}"

while IFS= read -r -d '' file; do
  if head -n 10 "$file" | grep -q "^output:"; then
    "$LUGH_BIN" -f "$file" && echo "~ $file has been tangled"
  fi
done < <(find "$SOURCE_PATH" -type f -name '*.md' -print0)
