{{- if (eq .chezmoi.os "linux") -}}
#!/usr/bin/env bash

set -euo pipefail

echo "Checking 1Password socket permissions..."

# The 1Password socket location
SOCKET_PATH="$HOME/.1password/agent.sock"

# Check if 1Password is installed
if ! command -v 1password &> /dev/null; then
    echo "1Password is not installed, skipping socket fix"
    exit 0
fi

# Check if the socket exists
if [[ ! -e "$SOCKET_PATH" ]]; then
    echo "1Password socket not found at $SOCKET_PATH"
    echo "Make sure 1Password Desktop is running and SSH agent integration is enabled"
    exit 0
fi

# Check if user is in the onepassword group
if ! groups | grep -q onepassword; then
    echo "Adding user to 'onepassword' group..."
    if command -v sudo &> /dev/null; then
        sudo usermod -aG onepassword "$USER"
        echo "User added to 'onepassword' group"
        echo "NOTE: You may need to log out and log back in for group changes to take effect"
    else
        echo "WARNING: sudo not available, cannot add user to group"
        exit 1
    fi
fi

# Fix socket permissions if needed
if [[ -S "$SOCKET_PATH" ]]; then
    SOCKET_GROUP=$(stat -c '%G' "$SOCKET_PATH")
    SOCKET_PERMS=$(stat -c '%a' "$SOCKET_PATH")

    if [[ "$SOCKET_GROUP" != "onepassword" ]] || [[ "$SOCKET_PERMS" != "660" ]]; then
        echo "Fixing socket group ownership and permissions..."
        if command -v sudo &> /dev/null; then
            sudo chgrp onepassword "$SOCKET_PATH"
            sudo chmod 660 "$SOCKET_PATH"
            echo "Socket group ownership and permissions fixed"
        else
            echo "WARNING: sudo not available, cannot fix socket permissions"
        fi
    else
        echo "Socket permissions look good!"
    fi
fi

# Verify socket is accessible
if [[ -r "$SOCKET_PATH" ]] && [[ -w "$SOCKET_PATH" ]]; then
    echo "1Password socket is accessible"
else
    echo "WARNING: Socket exists but may not be accessible"
    echo "You may need to log out and log back in for group changes to take effect"
fi

{{ end -}}
